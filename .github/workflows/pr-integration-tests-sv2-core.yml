name: Integration Tests for sv2-core-test PR

# This workflow should be placed in the sv2-core-test repository
# It triggers integration tests whenever a PR is opened, updated, or reopened

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

jobs:
  integration-tests:
    name: Run Integration Tests
    uses: GitGab19/sv2-integration-test-framework-test/.github/workflows/test-with-branch.yml@main
    with:
      repo_name: "sv2-core-test"
      branch_name: ${{ github.head_ref }}
      repo_url: ${{ github.event.pull_request.head.repo.html_url }}
      repo_slug: ${{ github.event.pull_request.head.repo.full_name }}
      pr_number: ${{ github.event.number }}
    secrets: inherit

  # Optional: Add a comment to the PR with test results
  comment-results:
    name: Comment Test Results
    needs: integration-tests
    if: always()
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ğŸ§ª Integration Test Results')
            );
            
            const success = '${{ needs.integration-tests.result }}' === 'success';
            const commentBody = `
            ## ğŸ§ª Integration Test Results
            
            **Repository**: sv2-core-test  
            **Branch**: \`${{ github.head_ref }}\`  
            **PR**: #${{ github.event.number }}  
            **Status**: ${success ? 'âœ… PASSED' : 'âŒ FAILED'}  
            **Workflow Run**: [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ${success ? 
              'All integration tests passed successfully! ğŸ‰' : 
              'Some integration tests failed. Please check the workflow run for details.'}
            
            ---
            *This comment is automatically updated when new commits are pushed.*
            `;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            } 